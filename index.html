<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Bot Testing Pipeline</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { margin: 0; font-family: system-ui, -apple-system, sans-serif; background: #f9fafb; }
        * { box-sizing: border-box; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spin { animation: spin 1s linear infinite; }
        input:focus, textarea:focus, button:focus { outline: 2px solid #3b82f6; outline-offset: 2px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;

        const testScenarios = [
            { name: "Standard Pricing Inquiry", persona: "Busy professional needing suit cleaning", objective: "Ask about suit cleaning pricing and turnaround time" },
            { name: "Urgent Same-Day Request", persona: "Person with emergency stain before event", objective: "Need dress cleaned urgently within 24 hours" },
            { name: "Wedding Dress Quote", persona: "Bride needing wedding dress cleaning", objective: "Ask about wedding dress cleaning and pricing" },
            { name: "Commercial Inquiry", persona: "Restaurant manager", objective: "Ask about bulk tablecloth and napkin cleaning services" },
            { name: "After Hours Contact", persona: "Customer calling outside business hours", objective: "Need to arrange drop-off for urgent cleaning" },
            { name: "Refund Policy Question", persona: "Skeptical customer", objective: "Ask about guarantees and what happens if not satisfied" },
            { name: "Out of Service Area", persona: "Customer from Brighton", objective: "Ask if you service Brighton area" },
            { name: "Item Requiring Quote", persona: "Customer with unusual item", objective: "Ask about cleaning a large area rug" },
            { name: "Multi-Item Booking", persona: "Customer needing multiple items cleaned", objective: "Book cleaning for 2 suits, 3 shirts, 1 dress" },
            { name: "Price Objection", persona: "Price-sensitive customer", objective: "Think prices are too high, considering competitors" },
            { name: "Priority Service Inquiry", persona: "Wealthy customer needing VIP service", objective: "Ask about fastest possible service options" },
            { name: "Complaint Scenario", persona: "Upset customer about previous service", objective: "Express frustration about a stain not fully removed" },
            { name: "Off-Topic Question", persona: "Confused customer", objective: "Ask if they do shoe repair or alterations" },
            { name: "Booking Details Collection", persona: "Ready-to-book customer", objective: "Want to book service and provide contact details" },
            { name: "Business Hours Confusion", persona: "Customer unsure about hours", objective: "Ask if open on Sundays and what time closes on Saturday" },
            { name: "Duvet Cleaning Inquiry", persona: "Homeowner with large duvet", objective: "Ask about duvet cleaning pricing and turnaround" },
            { name: "Stain Urgency Push", persona: "Procrastinating customer with old stain", objective: "Asking about wine stain from last week" },
            { name: "Multiple Questions Rapid Fire", persona: "Thorough customer", objective: "Ask about pricing, hours, location, and guarantees in quick succession" }
        ];

        function App() {
            const [apiKey, setApiKey] = useState('');
            const [brandVoice, setBrandVoice] = useState('');
            const [kb, setKb] = useState('');
            const [botGoals, setBotGoals] = useState('');
            const [testing, setTesting] = useState(false);
            const [currentTest, setCurrentTest] = useState(0);
            const [conversations, setConversations] = useState([]);
            const [report, setReport] = useState(null);

            const callClaude = async (messages) => {
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-api-key": apiKey,
                        "anthropic-version": "2023-06-01"
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 1000,
                        messages: messages,
                    })
                });
                if (!response.ok) throw new Error(`API call failed: ${response.statusText}`);
                return await response.json();
            };

            const simulateConversation = async (scenario) => {
                const messages = [];
                const conversationHistory = [];
                
                const customerResponse = await callClaude([{ role: "user", content: `You are roleplaying as: ${scenario.persona}\nYour objective: ${scenario.objective}\n\nStart a conversation with a business bot. Be natural and realistic. Send your first message as this customer would. Keep it conversational and brief (1-2 sentences).` }]);
                const customerMessage = customerResponse.content[0].text;
                messages.push({ role: "customer", text: customerMessage });
                conversationHistory.push({ role: "user", content: customerMessage });

                for (let turn = 0; turn < 6; turn++) {
                    const botResponse = await callClaude([{ role: "user", content: `You are a conversation bot. Use these documents:\n\nBRAND VOICE:\n${brandVoice}\n\nKNOWLEDGE BASE:\n${kb}\n\nBOT GOALS:\n${botGoals}\n\nConversation:\n${conversationHistory.map(m => `${m.role === 'user' ? 'Customer' : 'Bot'}: ${m.content}`).join('\n')}\n\nRespond as the bot would. Keep it natural (2-4 sentences). End with [CONVERSATION_END] if done.` }]);
                    const botMessage = botResponse.content[0].text;
                    messages.push({ role: "bot", text: botMessage });
                    conversationHistory.push({ role: "assistant", content: botMessage });
                    if (botMessage.includes('[CONVERSATION_END]')) break;

                    const customerContinue = await callClaude([{ role: "user", content: `You are: ${scenario.persona}\nObjective: ${scenario.objective}\n\nConversation:\n${conversationHistory.map(m => `${m.role === 'user' ? 'You' : 'Bot'}: ${m.content}`).join('\n')}\n\nContinue naturally. Say "Thanks!" if done. Keep brief (1-2 sentences).` }]);
                    const nextMessage = customerContinue.content[0].text;
                    if (nextMessage.toLowerCase().includes('thanks') && nextMessage.length < 30) {
                        messages.push({ role: "customer", text: nextMessage });
                        break;
                    }
                    messages.push({ role: "customer", text: nextMessage });
                    conversationHistory.push({ role: "user", content: nextMessage });
                }
                return messages;
            };

            const evaluateConversation = async (conversation, scenario) => {
                const conversationText = conversation.map(m => `${m.role === 'customer' ? 'Customer' : 'Bot'}: ${m.text}`).join('\n\n');
                const evaluationResponse = await callClaude([{ role: "user", content: `Evaluate this bot conversation:\n\nSCENARIO: ${scenario.name}\nPERSONA: ${scenario.persona}\nOBJECTIVE: ${scenario.objective}\n\nBRAND VOICE:\n${brandVoice}\n\nKB:\n${kb}\n\nGOALS:\n${botGoals}\n\nCONVERSATION:\n${conversationText}\n\nScore (0-100): brandVoice, knowledgeAccuracy, goalAlignment, responseQuality, boundaryHandling, overallScore. Respond ONLY with JSON:\n{"brandVoice":85,"knowledgeAccuracy":90,"goalAlignment":88,"responseQuality":92,"boundaryHandling":95,"overallScore":90,"strengths":["x","y"],"weaknesses":["a","b"],"criticalIssues":[]}` }]);
                const text = evaluationResponse.content[0].text.replace(/```json|```/g, '').trim();
                return JSON.parse(text);
            };

            const generateReport = async (results) => {
                const validResults = results.filter(r => !r.error);
                if (validResults.length === 0) return { passed: false, overallScore: 0, message: "Testing failed" };
                
                const avgScore = validResults.reduce((sum, r) => sum + r.evaluation.overallScore, 0) / validResults.length;
                const avgBrandVoice = validResults.reduce((sum, r) => sum + r.evaluation.brandVoice, 0) / validResults.length;
                const avgKnowledge = validResults.reduce((sum, r) => sum + r.evaluation.knowledgeAccuracy, 0) / validResults.length;
                const avgGoals = validResults.reduce((sum, r) => sum + r.evaluation.goalAlignment, 0) / validResults.length;
                
                const reportResponse = await callClaude([{ role: "user", content: `Generate report:\nSCORE: ${avgScore.toFixed(1)}%\nBrand Voice: ${avgBrandVoice.toFixed(1)}%\nKB: ${avgKnowledge.toFixed(1)}%\nGoals: ${avgGoals.toFixed(1)}%\n\nProvide summary and recommendations. JSON only:\n{"passed":true,"summary":"text","brandVoiceRating":"Strong","brandVoiceRecommendations":["x"],"knowledgeBaseRating":"Strong","knowledgeBaseRecommendations":["y"],"botGoalsRating":"Strong","botGoalsRecommendations":["z"],"topPriorities":["a","b","c"]}` }]);
                const reportData = JSON.parse(reportResponse.content[0].text.replace(/```json|```/g, '').trim());
                
                return { passed: avgScore >= 90, overallScore: avgScore, totalTests: validResults.length, componentScores: { brandVoice: avgBrandVoice, knowledge: avgKnowledge, goals: avgGoals }, ...reportData };
            };

            const runTests = async () => {
                if (!apiKey || !brandVoice || !kb || !botGoals) {
                    alert('Please fill in all fields including API key.');
                    return;
                }
                setTesting(true);
                setCurrentTest(0);
                setConversations([]);
                setReport(null);
                const results = [];
                
                for (let i = 0; i < testScenarios.length; i++) {
                    setCurrentTest(i + 1);
                    const scenario = testScenarios[i];
                    try {
                        const conversation = await simulateConversation(scenario);
                        const evaluation = await evaluateConversation(conversation, scenario);
                        results.push({ scenario: scenario.name, conversation, evaluation });
                        setConversations(prev => [...prev, { scenario: scenario.name, messages: conversation, score: evaluation.overallScore }]);
                    } catch (error) {
                        console.error(`Test ${i + 1} failed:`, error);
                        results.push({ scenario: scenario.name, error: error.message });
                    }
                }
                
                const finalReport = await generateReport(results);
                setReport(finalReport);
                setTesting(false);
            };

            return (
                <div style={{minHeight:'100vh',padding:'24px'}}>
                    <div style={{maxWidth:'1152px',margin:'0 auto'}}>
                        <div style={{background:'white',borderRadius:'8px',boxShadow:'0 1px 3px rgba(0,0,0,0.1)',padding:'32px',marginBottom:'24px'}}>
                            <h1 style={{fontSize:'30px',fontWeight:'bold',marginBottom:'8px'}}>AI Bot Testing Pipeline</h1>
                            <p style={{color:'#6b7280',marginBottom:'24px'}}>Test your conversation bot with 18 simulated scenarios</p>
                            
                            <div style={{marginBottom:'24px',padding:'16px',background:'#eff6ff',borderRadius:'8px',border:'1px solid #3b82f6'}}>
                                <label style={{display:'block',fontSize:'14px',fontWeight:'500',marginBottom:'8px'}}>Anthropic API Key</label>
                                <input type="password" value={apiKey} onChange={(e)=>setApiKey(e.target.value)} placeholder="sk-ant-..." style={{width:'100%',padding:'12px',border:'1px solid #d1d5db',borderRadius:'8px'}} disabled={testing}/>
                                <p style={{fontSize:'12px',color:'#6b7280',marginTop:'8px'}}>Get your key from <a href="https://console.anthropic.com" target="_blank" style={{color:'#3b82f6'}}>console.anthropic.com</a></p>
                            </div>

                            <div style={{marginBottom:'16px'}}>
                                <label style={{display:'block',fontSize:'14px',fontWeight:'500',marginBottom:'8px'}}>Brand Voice Document</label>
                                <textarea value={brandVoice} onChange={(e)=>setBrandVoice(e.target.value)} placeholder="Paste brand voice..." style={{width:'100%',height:'128px',padding:'12px',border:'1px solid #d1d5db',borderRadius:'8px',fontFamily:'monospace',fontSize:'13px'}} disabled={testing}/>
                            </div>

                            <div style={{marginBottom:'16px'}}>
                                <label style={{display:'block',fontSize:'14px',fontWeight:'500',marginBottom:'8px'}}>Knowledge Base Document</label>
                                <textarea value={kb} onChange={(e)=>setKb(e.target.value)} placeholder="Paste knowledge base..." style={{width:'100%',height:'128px',padding:'12px',border:'1px solid #d1d5db',borderRadius:'8px',fontFamily:'monospace',fontSize:'13px'}} disabled={testing}/>
                            </div>

                            <div style={{marginBottom:'24px'}}>
                                <label style={{display:'block',fontSize:'14px',fontWeight:'500',marginBottom:'8px'}}>Bot Goals Document</label>
                                <textarea value={botGoals} onChange={(e)=>setBotGoals(e.target.value)} placeholder="Paste bot goals..." style={{width:'100%',height:'128px',padding:'12px',border:'1px solid #d1d5db',borderRadius:'8px',fontFamily:'monospace',fontSize:'13px'}} disabled={testing}/>
                            </div>

                            <button onClick={runTests} disabled={testing||!apiKey||!brandVoice||!kb||!botGoals} style={{width:'100%',background:testing||!apiKey||!brandVoice||!kb||!botGoals?'#d1d5db':'#2563eb',color:'white',padding:'12px',borderRadius:'8px',fontWeight:'500',border:'none',cursor:testing||!apiKey||!brandVoice||!kb||!botGoals?'not-allowed':'pointer'}}>
                                {testing ? `Running Test ${currentTest} of ${testScenarios.length}...` : `Run ${testScenarios.length} Tests`}
                            </button>
                        </div>

                        {testing && (
                            <div style={{background:'white',borderRadius:'8px',boxShadow:'0 1px 3px rgba(0,0,0,0.1)',padding:'24px',marginBottom:'24px'}}>
                                <h2 style={{fontSize:'20px',fontWeight:'600',marginBottom:'16px'}}>Testing in Progress...</h2>
                                <div style={{width:'100%',background:'#e5e7eb',borderRadius:'9999px',height:'12px'}}>
                                    <div style={{background:'#2563eb',height:'12px',borderRadius:'9999px',width:`${(currentTest/testScenarios.length)*100}%`,transition:'width 0.3s'}}/>
                                </div>
                                <p style={{fontSize:'14px',color:'#6b7280',marginTop:'8px'}}>{currentTest>0&&`Current: ${testScenarios[currentTest-1].name}`}</p>
                            </div>
                        )}

                        {conversations.length>0 && (
                            <div style={{background:'white',borderRadius:'8px',boxShadow:'0 1px 3px rgba(0,0,0,0.1)',padding:'24px',marginBottom:'24px'}}>
                                <h2 style={{fontSize:'20px',fontWeight:'600',marginBottom:'16px'}}>Test Results</h2>
                                {conversations.map((c,i)=>(
                                    <div key={i} style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'12px',background:'#f9fafb',borderRadius:'8px',marginBottom:'12px'}}>
                                        <span style={{fontWeight:'500'}}>{c.scenario}</span>
                                        <span style={{fontWeight:'600',color:c.score>=90?'#16a34a':c.score>=75?'#ca8a04':'#dc2626'}}>{c.score.toFixed(0)}%</span>
                                    </div>
                                ))}
                            </div>
                        )}

                        {report && (
                            <div style={{background:'white',borderRadius:'8px',boxShadow:'0 1px 3px rgba(0,0,0,0.1)',padding:'32px'}}>
                                <h2 style={{fontSize:'24px',fontWeight:'bold',marginBottom:'8px'}}>{report.passed?'PASSED':'FAILED'} - {report.overallScore.toFixed(1)}%</h2>
                                <p style={{color:'#6b7280',marginBottom:'24px'}}>{report.totalTests} tests completed</p>
                                <div style={{marginBottom:'24px',padding:'16px',background:'#f9fafb',borderRadius:'8px'}}>
                                    <p>{report.summary}</p>
                                </div>
                                <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:'16px',marginBottom:'32px'}}>
                                    <div style={{textAlign:'center',padding:'16px',background:'#eff6ff',borderRadius:'8px'}}>
                                        <div style={{fontSize:'14px',color:'#6b7280',marginBottom:'4px'}}>Brand Voice</div>
                                        <div style={{fontSize:'24px',fontWeight:'bold'}}>{report.componentScores.brandVoice.toFixed(0)}%</div>
                                        <div style={{fontSize:'14px',fontWeight:'500',color:report.brandVoiceRating==='Strong'?'#16a34a':report.brandVoiceRating==='Adequate'?'#ca8a04':'#dc2626'}}>{report.brandVoiceRating}</div>
                                    </div>
                                    <div style={{textAlign:'center',padding:'16px',background:'#eff6ff',borderRadius:'8px'}}>
                                        <div style={{fontSize:'14px',color:'#6b7280',marginBottom:'4px'}}>Knowledge Base</div>
                                        <div style={{fontSize:'24px',fontWeight:'bold'}}>{report.componentScores.knowledge.toFixed(0)}%</div>
                                        <div style={{fontSize:'14px',fontWeight:'500',color:report.knowledgeBaseRating==='Strong'?'#16a34a':report.knowledgeBaseRating==='Adequate'?'#ca8a04':'#dc2626'}}>{report.knowledgeBaseRating}</div>
                                    </div>
                                    <div style={{textAlign:'center',padding:'16px',background:'#eff6ff',borderRadius:'8px'}}>
                                        <div style={{fontSize:'14px',color:'#6b7280',marginBottom:'4px'}}>Bot Goals</div>
                                        <div style={{fontSize:'24px',fontWeight:'bold'}}>{report.componentScores.goals.toFixed(0)}%</div>
                                        <div style={{fontSize:'14px',fontWeight:'500',color:report.botGoalsRating==='Strong'?'#16a34a':report.botGoalsRating==='Adequate'?'#ca8a04':'#dc2626'}}>{report.botGoalsRating}</div>
                                    </div>
                                </div>
                                <div style={{marginBottom:'24px'}}>
                                    <h3 style={{fontSize:'18px',fontWeight:'600',marginBottom:'12px'}}>ðŸŽ¯ Top Priorities</h3>
                                    {report.topPriorities.map((p,i)=>(
                                        <div key={i} style={{padding:'12px',background:'#fef2f2',borderLeft:'4px solid #dc2626',borderRadius:'4px',marginBottom:'8px'}}>{p}</div>
                                    ))}
                                </div>
                                <div style={{marginBottom:'24px'}}>
                                    <h3 style={{fontSize:'18px',fontWeight:'600',marginBottom:'12px'}}>Brand Voice Recommendations</h3>
                                    {report.brandVoiceRecommendations.map((r,i)=><div key={i} style={{marginBottom:'8px'}}>â€¢ {r}</div>)}
                                </div>
                                <div style={{marginBottom:'24px'}}>
                                    <h3 style={{fontSize:'18px',fontWeight:'600',marginBottom:'12px'}}>Knowledge Base Recommendations</h3>
                                    {report.knowledgeBaseRecommendations.map((r,i)=><div key={i} style={{marginBottom:'8px'}}>â€¢ {r}</div>)}
                                </div>
                                <div>
                                    <h3 style={{fontSize:'18px',fontWeight:'600',marginBottom:'12px'}}>Bot Goals Recommendations</h3>
                                    {report.botGoalsRecommendations.map((r,i)=><div key={i} style={{marginBottom:'8px'}}>â€¢ {r}</div>)}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
